{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Request: {{ request_obj.title }}{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'pos_app/css/add_requestStyle.css' %}">
{% endblock %}

{% block content %}
<main class="main-content-area">
    <div class="add-request-card">
        
        <div class="card-header">
            <div>
                <h1>Edit Request</h1>
                <p class="subtitle">Modify request details</p>
            </div>
            <a href="{% url 'dashboard' %}" class="back-link">
                Back to Dashboard
            </a>
        </div>

        {% if messages %}
        <ul class="messages" style="list-style:none; padding:0; margin-bottom: 20px; color: var(--primary-maroon);">
            {% for message in messages %}
            <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        <form method="POST" enctype="multipart/form-data" class="request-form">
            {% csrf_token %}

            <div class="form-grid">
                
                <div class="form-group form-group-full">
                    <label for="id_title">Request Title</label>
                    <input type="text" id="id_title" name="title" class="modern-input" required value="{{ request_obj.title }}">
                </div>
                
                <div class="form-group">
                    <label>Current Status</label>
                    <div class="read-only-wrapper">
                        <span class="status-badge {{ request_obj.status|lower }}">
                            {{ request_obj.get_status_display }}
                        </span>
                    </div>
                    <input type="hidden" name="status" value="{{ request_obj.status }}">
                </div>

                <div class="form-group">
                    <label for="id_priority">Priority Level</label>
                    <select id="id_priority" name="priority" class="modern-select">
                        <option value="low" {% if request_obj.priority == "low" %}selected{% endif %}>Low</option>
                        <option value="medium" {% if request_obj.priority == "medium" %}selected{% endif %}>Medium</option>
                        <option value="high" {% if request_obj.priority == "high" %}selected{% endif %}>High</option>
                        <option value="critical" {% if request_obj.priority == "critical" %}selected{% endif %}>Critical</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="id_category">Category</label>
                    <select id="id_category" name="category" class="modern-select" required>
                        <option value="">Select Category</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {% if request_obj.category.id == category.id %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="id_query_type">Query Type</label>
                    <select name="category_choice" id="id_query_type" class="modern-select" required>
                        <option value="">Select Query Type</option>
                        {% for choice in category_choices %}
                            <option value="{{ choice.id }}" data-category="{{ choice.category.id }}" 
                                {% if request_obj.category_choice.id == choice.id %}selected{% endif %}>
                                {{ choice.value }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group form-group-full">
                    <label for="id_tags">Tags</label>
                    <input type="text" id="id_tags" name="tags" class="modern-input" placeholder="e.g., urgent, finance" value="{{ current_tags_str }}">
                </div>
                
                <div class="form-group form-group-full">
                    <label for="id_description">Description / Details</label>
                    <textarea id="id_description" name="description" class="modern-textarea" required rows="6">{{ request_obj.description }}</textarea>
                </div>

                <div class="form-group form-group-full">
                    <label>Attachment</label>
                    
                    <div class="file-upload-wrapper">
                        <input type="file" id="id_attachment" name="attachment" class="file-input-hidden" onchange="updateFileName(this)">
                        
                        <div class="upload-content">
                            <span class="upload-text" id="fileName">
                                {% if request_obj.attachment %}
                                    Current: {{ request_obj.attachment.name|cut:"pos_app/attachments/" }}
                                {% else %}
                                    Click to upload new file
                                {% endif %}
                            </span>
                            <span class="upload-hint">
                                {% if request_obj.attachment %}
                                    (Click to replace)
                                {% else %}
                                    PDF, PNG, JPG (Max 10MB)
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    
                    {% if request_obj.attachment %}
                    <div style="margin-top: 8px; font-size: 0.85rem;">
                        <a href="{{ request_obj.attachment.url }}" target="_blank" style="color: var(--primary-maroon); text-decoration: underline;">
                            View current attachment
                        </a>
                    </div>
                    {% endif %}
                </div>

            </div>

            <div class="btn-group">
                <a href="{% url 'dashboard' %}" class="btn btn-cancel">Cancel</a>
                <button type="submit" class="btn btn-save">Save Changes</button>
            </div>
        </form>
    </div>
</main>
{% endblock content %}

{% block extra_js %}
<script>
    const categorySelect = document.getElementById('id_category');
    const choiceSelect = document.getElementById('id_query_type');
    
    // Store all options initially
    const allOptions = Array.from(choiceSelect.querySelectorAll('option')).filter(opt => opt.value !== "");

    function filterQueryTypes() {
        const selectedCategory = categorySelect.value;
        const currentChoiceId = choiceSelect.value;

        // Reset
        choiceSelect.innerHTML = '<option value="">Select Query Type</option>';

        if (selectedCategory) {
            // Filter options
            const matchingOptions = allOptions.filter(option => 
                option.dataset.category === selectedCategory
            );
            
            matchingOptions.forEach(option => {
                choiceSelect.appendChild(option);
            });

            choiceSelect.disabled = false;

            // Restore selection if it belongs to this category
            const stillExists = matchingOptions.some(opt => opt.value === currentChoiceId);
            if (stillExists) {
                choiceSelect.value = currentChoiceId;
            }
        } else {
            choiceSelect.disabled = true;
        }
    }

    categorySelect.addEventListener('change', filterQueryTypes);
    
    // Run once on load to set initial state correctly
    filterQueryTypes();

    // File Name Update Logic
    function updateFileName(input) {
        const fileNameSpan = document.getElementById('fileName');
        if (input.files && input.files.length > 0) {
            fileNameSpan.textContent = "Selected: " + input.files[0].name;
            fileNameSpan.style.color = "#993333";
            fileNameSpan.style.fontWeight = "600";
        }
    }
</script>
{% endblock %}
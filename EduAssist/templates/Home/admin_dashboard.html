{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Panel{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'pos_app/css/dashboardStyle.css' %}">
<link rel="stylesheet" href="{% static 'pos_app/css/adminPanelStyle.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2>User Profiles</h2>
    
    <div class="top-actions">
        <input type="text" id="search" placeholder="Search users" onkeyup="filterTable()">
        </div>

    {% if users %}
    <div class="table-responsive">
        <table id="userTable">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Contact</th>
                    <th>Program</th>
                    <th>Year Level</th>
                    <th>Manage</th>
                </tr>
            </thead>
            <tbody>
                {% for profile in users %}
                <tr>
                    <td data-label="Username">{{ profile.user.username }}</td>
                    <td data-label="Contact">{{ profile.contact }}</td>
                    <td data-label="Program">{{ profile.program }}</td>
                    <td data-label="Year Level">{{ profile.year_level }}</td>
                    <td>
    <div class="action-buttons">

        {% if request.user.profile.role == "SUPERADMIN" %}
        <span class="role-badge changeRoleBtn"
              data-id="{{ profile.id }}"
              data-role="{{ profile.role }}"
              data-name="{{ profile.user.username }}">
            {{ profile.role }}
            <i class="fas fa-edit"></i>
        </span>
        {% else %}
        <span class="role-badge disabled">{{ profile.role }}</span>
        {% endif %}

        {% if request.user.id == profile.user.id %}
            <!-- Can't delete yourself -->
            <button class="delete-btn disabled-delete">
                <i class="fas fa-trash"></i>
            </button>

        {% elif request.user.profile.role == "ADMIN" and profile.role in "ADMIN SUPERADMIN" %}
            <!-- Admin cannot delete Admin or Superadmin -->
            <button class="delete-btn disabled-delete">
                <i class="fas fa-trash"></i>
            </button>

        {% else %}
            <!-- Normal delete -->
            <button class="delete-btn"
                    data-id="{{ profile.id }}"
                    data-name="{{ profile.user.username }}">
                <i class="fas fa-trash"></i>
            </button>
        {% endif %}

    </div>
</td>

                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p id="noResultsMessage"></p>
    </div>
    {% else %}
    <p class="empty">No user profiles found.</p>
    {% endif %}
</div>

<div id="roleModal" class="modal">
    <div class="modal-content">
        <h3>Change Role</h3>
        <p id="modalMessage"></p>

        <form method="POST" id="roleForm">
            {% csrf_token %}
            <select name="role" id="roleSelect">
                <option value="SUPERADMIN">Super Admin</option>
                <option value="ADMIN">Admin</option>
                <option value="STUDENT">Student</option>
            </select>

            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn-confirm">Confirm</button>
            </div>
        </form>
    </div>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3>Confirm Delete</h3>
        <p id="deleteMessage"></p>

        <form method="POST" id="deleteForm">
            {% csrf_token %}
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button type="submit" class="btn-confirm">Delete</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function filterTable() {
    const searchInput = document.getElementById("search").value.toLowerCase();
    const table = document.getElementById("userTable");
    const tbody = table ? table.querySelector("tbody") : null;
    const rows = tbody ? tbody.getElementsByTagName("tr") : [];
    let visibleRowCount = 0;

    if (!tbody) return;

    for (let i = 0; i < rows.length; i++) {
        // Get all cell data from the current row
        const cells = rows[i].getElementsByTagName('td');
        let rowMatches = false;

        // Iterate through all cells to see if any content matches the search input
        for (let j = 0; j < cells.length; j++) {
            const cellText = cells[j].textContent || cells[j].innerText;
            if (cellText.toLowerCase().includes(searchInput)) {
                rowMatches = true;
                break;
            }
        }

        if (rowMatches) {
            rows[i].style.display = "";
            visibleRowCount++;
        } else {
            rows[i].style.display = "none";
        }
    }

    // Display 'no results' message
    const noResults = document.getElementById("noResultsMessage");
    if (noResults) {
        // Only show no results if the table has rows but none are visible
        noResults.textContent = (visibleRowCount === 0 && rows.length > 0) 
            ? "ðŸš« No user profiles match your search criteria." 
            : "";
    }
}

let modal = document.getElementById("roleModal")
let form = document.getElementById("roleForm")
let message = document.getElementById("modalMessage")
let roleSelect = document.getElementById("roleSelect")

document.querySelectorAll(".changeRoleBtn").forEach(btn => {
    btn.addEventListener("click", function() {
        let id = this.dataset.id
        let username = this.dataset.name
        let role = this.dataset.role

        message.innerHTML = `Change role for <b>${username}</b>?`
        form.action = `/accounts/change-role/${id}/`
        roleSelect.value = role

        modal.style.display = "flex"
    })
})

function closeModal() {
    modal.style.display = "none"
}

// DELETE MODAL
let deleteModal = document.getElementById("deleteModal");
let deleteForm = document.getElementById("deleteForm");
let deleteMessage = document.getElementById("deleteMessage");

document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        let id = this.dataset.id;
        let username = this.dataset.name;

        deleteMessage.innerHTML = `Are you sure you want to delete <b>${username}</b>?`;
        deleteForm.action = `/accounts/delete-user/${id}/`;

        deleteModal.style.display = "flex";
    });
});

function closeDeleteModal() {
    deleteModal.style.display = "none";
}

</script>
{% endblock %}
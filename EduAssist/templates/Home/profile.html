{% extends 'base.html' %} 
{% load static %}

{% block title %}Profile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'pos_app/css/dashboardStyle.css' %}">
<link rel="stylesheet" href="{% static 'pos_app/css/profileStyle.css' %}">
{% endblock %}

{% block content %}
<main>
    <div class="profile-card">
        <h2>My Profile</h2>
        <p class="profile-subtitle">Manage your personal information</p>

        <div class="user-details">
            <p><strong>Username:</strong> {{ user_info.username|default:"" }}</p>
            <p><strong>Email:</strong> {{ user_info.email|default:"" }}</p>
        </div>

        <form method="post" id="profileForm" class="profile-form">
            {% csrf_token %}
            {{ form.as_p }}

            <div class="form-actions">
                <button type="button" id="editBtn" class="btn-secondary">Edit</button>
                <button type="submit" id="saveBtn" class="btn-save" disabled>Save Changes</button>
            </div>
        </form>

        <div class="messages">
            {% for message in messages %}
                <p class="{{ message.tags }}">{{ message }}</p>
            {% endfor %}
        </div>

        <div class="extra-actions">
            <form method="get" action="{% url 'change_password' %}">
                <button type="submit" class="btn-secondary">Change Password</button>
            </form>

            {% if not user.is_staff %}
            <form method="get" action="{% url 'my_feedback' %}">
                <button type="submit" class="btn-primary">My Feedback</button>
            </form>
            {% endif %}
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    // Fields that the user is allowed to edit
    const editableFields = ["id_contact", "id_program", "id_year_level"]; 

    // Lock all editable fields on load
    editableFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            // Check if it's a select element before setting 'readonly'
            if (field.tagName === 'SELECT') {
                field.setAttribute("disabled", "true"); // Use disabled for select fields
            } else {
                field.setAttribute("readonly", "true");
            }
            field.classList.remove("editable");
        }
    });

    let isEditing = false;

    editBtn.addEventListener("click", () => {
        isEditing = !isEditing;

        editableFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                if (isEditing) {
                    if (field.tagName === 'SELECT') {
                        field.removeAttribute("disabled");
                    } else {
                        field.removeAttribute("readonly");
                    }
                    field.classList.add("editable");
                } else {
                    if (field.tagName === 'SELECT') {
                        field.setAttribute("disabled", "true");
                    } else {
                        field.setAttribute("readonly", "true");
                    }
                    field.classList.remove("editable");
                }
            }
        });

        // Toggle button states
        editBtn.textContent = isEditing ? "Cancel Edit" : "Edit";
        saveBtn.disabled = !isEditing;
    });
});
</script>
{% endblock %}
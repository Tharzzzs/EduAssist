{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile</title>
  <link rel="stylesheet" href="{% static 'pos_app/css/profileStyle.css' %}">
  <link rel="stylesheet" href="{% static 'pos_app/css/theme.css' %}">
  <script src="{% static 'pos_app/js/theme-cookie.js' %}" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <header>
    <div class="logo">EduAssist</div>
    <nav class="main-nav">
        {% if user.is_staff %}
            <a href="{% url 'dashboard' %}">All Requests</a>
            <a href="{% url 'admin_dashboard' %}">Admin Panel</a>
            <a href="{% url 'create_category' %}">Create Category</a>
        {% else %}
            <a href="{% url 'dashboard' %}">My Requests</a>
        {% endif %}
    </nav>

    <!-- User Dropdown Menu -->
    <div class="user-menu-container">
        <button class="menu-toggle-btn" onclick="toggleMenu()">
            <i class="fa-solid fa-bars"></i>
        </button>

        <div class="dropdown-menu" id="userDropdown">
            <a href="{% url 'profile' %}">
                <i class="fa-solid fa-user-circle"></i> Profile
            </a>
            <a href="{% url 'settings' %}">
                <i class="fa-solid fa-gear"></i> Settings
            </a>
            <a href="{% url 'logout' %}" class="logout-link">
                <i class="fa-solid fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>
</header>

  <main>
    <div class="profile-card">
      <h2>My Profile</h2>
      <p class="profile-subtitle">Manage your personal information</p>

      <div class="user-details">
        <p><strong>Username:</strong> {{ user_info.username|default:"" }}</p>
        <p><strong>Email:</strong> {{ user_info.email|default:"" }}</p>
      </div>

      <!-- Editable Profile Form -->
      <form method="post" id="profileForm" class="profile-form">
        {% csrf_token %}
        {{ form.as_p }}

        <div class="form-actions">
          <button type="button" id="editBtn" class="btn-secondary">Edit</button>
          <button type="submit" id="saveBtn" class="btn-save" disabled>Save Changes</button>
        </div>
      </form>

      <div class="messages">
        {% for message in messages %}
          <p class="{{ message.tags }}">{{ message }}</p>
        {% endfor %}
      </div>

      <div class="extra-actions">
        <!-- Change Password Button -->
        <form method="get" action="{% url 'change_password' %}">
          <button type="submit" class="btn-secondary">Change Password</button>
        </form>

        {% if not user.is_staff %}
        <!-- My Feedback Button (only for non-admin users) -->
        <form method="get" action="{% url 'my_feedback' %}">
          <button type="submit" class="btn-primary">My Feedback</button>
        </form>
        {% endif %}
      </div>

    </div>
  </main>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const editableFields = ["id_contact", "id_program", "id_year_level"];

    // Lock all editable fields on load
    editableFields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        field.setAttribute("readonly", "true");
        field.classList.remove("editable");
      }
    });

    let isEditing = false;

    editBtn.addEventListener("click", () => {
      isEditing = !isEditing;

      editableFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          if (isEditing) {
            field.removeAttribute("readonly");
            field.classList.add("editable");
          } else {
            field.setAttribute("readonly", "true");
            field.classList.remove("editable");
          }
        }
      });

      // Toggle button states
      editBtn.textContent = isEditing ? "Cancel Edit" : "Edit";
      saveBtn.disabled = !isEditing;
    });
  });

  function toggleMenu() {
    const dropdown = document.getElementById('userDropdown');
    dropdown.classList.toggle('show');
}

window.onclick = function(event) {
    if (!event.target.matches('.menu-toggle-btn') && !event.target.matches('.menu-toggle-btn i')) {
        const dropdown = document.getElementById('userDropdown');
        if (dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
        }
    }
}

</script>
</body>
</html>

{% extends 'base.html' %}
{% load static %}

{% block title %}Details: {{ req.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'pos_app/css/request_detailStyle.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="detail-container">
        <div class="card-top-header">
            <div class="card-top-left">
                <h1 class="card-top-title">View Request</h1>
                <p class="card-top-subtitle">View full request details</p>
            </div>

            <a href="{% url 'dashboard' %}" class="card-top-back">
                Back to Dashboard
            </a>
        </div>

        <hr class="card-header-divider">

        <div class="detail-info-grid">

    <!-- Title -->
    <div class="detail-card hover-card">
        <div class="label">Title</div>
        <div class="value">{{ req.title }}</div>
    </div>

    <!-- Status -->
    <div class="detail-card hover-card">
        <div class="label">Status</div>
        <span class="status-badge {{ req.status|lower }}">
            {{ req.get_status_display }}
        </span>
    </div>

    <!-- Priority -->
    <div class="detail-card hover-card">
        <div class="label">Priority</div>
        <div class="value priority-{{ req.priority }}">
            <span class="dot"></span>
            {{ req.get_priority_display }}
        </div>
    </div>

    <!-- Date -->
    <div class="detail-card hover-card">
        <div class="label">Date</div>
        <div class="value">{{ req.date|date:"F d, Y" }}</div>
    </div>

    <!-- Category -->
    <div class="detail-card hover-card">
        <div class="label">Category</div>
        <div class="value">{{ req.category.name }}</div>
    </div>

    <!-- Tags -->
    <div class="detail-card hover-card">
        <div class="label">Tags</div>
        <div class="tag-list">
            {% for tag in req.tags.all %}
                <span class="tag-badge">{{ tag.name }}</span>
            {% empty %}
                <span class="no-data">No tags</span>
            {% endfor %}
        </div>
    </div>

</div>

        
        {# Full-Width Sections follow the grid #}

        <div class="detail-card hover-card full-width-card">
            <div class="label">Description</div>
            <div class="value description-text">{{ req.description }}</div>
        </div>

        <div class="attachment-section">
            <strong>Attachment:</strong>
            {% if req.attachment %}
                <a href="{{ req.attachment.url }}" target="_blank">View Attachment</a>
            {% else %}
                <span>No attachment provided.</span>
            {% endif %}
        </div>

        <div class="detail-actions">
            
            {% if request.user.is_staff %}
            <a href="{% url 'approve_request' req.id %}" class="btn-primary">Update Status / Comment</a>

            <button 
                type="button" 
                onclick="openDeleteModal({{ req.id }}, '{{ req.title|escapejs }}');"
                class="btn-danger"
            >
                Delete
            </button>

            {% elif request.user == req.user %}
            <a href="{% url 'edit_request' req.id %}" class="btn-primary">Edit Request</a>
            
            <button 
                type="button" 
                onclick="openDeleteModal({{ req.id }}, '{{ req.title|escapejs }}');"
                class="btn-danger"
            >
                Delete
            </button>
            {% endif %}
        </div>
    </div>
</div>

<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-content delete-modal-content">
        <span class="close" onclick="closeDeleteModal()">&times;</span>
        
        <h2>Confirm Deletion</h2>
        
        <p class="warning-text">
            Are you sure you want to delete the request titled: 
            <strong id="deleteRequestTitle"></strong>?
        </p>

        <p class="detail-text">
            This action cannot be undone.
        </p>

        <form method="POST" id="deleteRequestForm" action="{% url 'delete_request' 0 %}">
            {% csrf_token %}
            
            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button type="submit" class="btn btn-danger">Yes, Delete It</button>
            </div>
        </form>
    </div>
</div>
{% endblock content %}


{% block extra_js %}
<script>
    const deleteUrlTemplate = "{% url 'delete_request' 0 %}"; 
    const idPlaceholder = '0'; 

    const deleteModal = document.getElementById('deleteModal');
    const deleteRequestForm = document.getElementById('deleteRequestForm');
    const deleteRequestTitle = document.getElementById('deleteRequestTitle');

    function openDeleteModal(requestId, requestTitle) {
        deleteRequestForm.action = deleteUrlTemplate.replace(idPlaceholder, requestId);
        deleteRequestTitle.textContent = requestTitle;
        deleteModal.style.display = 'flex';
    }

    function closeDeleteModal() {
        deleteModal.style.display = 'none';
    }

    window.addEventListener('click', (e) => {
        if (e.target === deleteModal) {
            closeDeleteModal();
        }
    });
</script>
{% endblock %}
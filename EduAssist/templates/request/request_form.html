{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
    <h2>{% if object %}Edit{% else %}Submit{% endif %} Request</h2>

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        {{ form.non_field_errors }}
        {% for field in form %}
            {% if field.name != 'tags' %}
                <div class="mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                    {{ field.errors }}
                </div>
            {% endif %}
        {% endfor %}

        <div class="mb-3">
            <label for="id_tags_input" class="form-label">Tags</label>
            <div id="selected-tags-container" class="mb-2">
                </div>
            
            <input type="text" id="id_tags_input" class="form-control" placeholder="Type to search or create tags (e.g., bug-fix, support)">
            
            {{ form.tags }} 
            
            <div id="tag-suggestions" class="list-group position-absolute z-index-1" style="max-height: 200px; overflow-y: auto; width: 300px;">
                </div>

            {{ form.tags.errors }}
            <div class="form-text">{{ form.tags.help_text|safe }}</div>
        </div>

        <button type="submit" class="btn btn-primary">Save Request</button>
    </form>
</div>

<script>
    // ----------------------------------------------------
    // ðŸ’¡ US-12: Tag Auto-Suggest Logic (using native JS/Fetch)
    // ----------------------------------------------------
    document.addEventListener('DOMContentLoaded', function() {
        const inputField = document.getElementById('id_tags_input');
        const suggestionsContainer = document.getElementById('tag-suggestions');
        const selectedTagsContainer = document.getElementById('selected-tags-container');
        const hiddenSelect = document.getElementById('id_tags'); // The actual Django form field (SelectMultiple)
        
        // Function to fetch suggestions from the API
        const fetchSuggestions = async (query) => {
            if (query.length < 2) {
                suggestionsContainer.innerHTML = '';
                return;
            }
            try {
                // Uses the API endpoint we created in views.py
                const response = await fetch(`/api/tags/autosuggest/?q=${query}`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!response.ok) {
                    // ðŸ’¡ Negative Path: Auto-suggest fails to load
                    suggestionsContainer.innerHTML = '<button type="button" class="list-group-item list-group-item-action disabled">Unable to fetch tag suggestions</button>';
                    return;
                }
                const tags = await response.json();
                renderSuggestions(tags);
            } catch (error) {
                console.error("Fetch error:", error);
                // ðŸ’¡ Negative Path: Auto-suggest fails to load
                suggestionsContainer.innerHTML = '<button type="button" class="list-group-item list-group-item-action disabled">Unable to fetch tag suggestions</button>';
            }
        };

        // Function to render the fetched suggestions
        const renderSuggestions = (tags) => {
            suggestionsContainer.innerHTML = '';
            if (tags.length === 0) {
                suggestionsContainer.innerHTML = '<button type="button" class="list-group-item list-group-item-action disabled">No existing tags found.</button>';
                return;
            }

            tags.forEach(tag => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'list-group-item list-group-item-action';
                button.textContent = tag.name;
                button.setAttribute('data-tag-id', tag.id);
                button.setAttribute('data-tag-name', tag.name);
                
                button.addEventListener('click', () => {
                    addTag(tag.id, tag.name);
                    inputField.value = ''; // Clear input
                    suggestionsContainer.innerHTML = ''; // Clear suggestions
                });
                suggestionsContainer.appendChild(button);
            });
        };
        
        // Function to update the hidden select and the visible tag container
        const updateSelectedTagsUI = () => {
            selectedTagsContainer.innerHTML = '';
            const selectedOptions = Array.from(hiddenSelect.options).filter(opt => opt.selected);

            selectedOptions.forEach(option => {
                const tagSpan = document.createElement('span');
                // Basic styling for a visible tag (requires minimal CSS, e.g., Bootstrap badge)
                tagSpan.className = 'badge bg-secondary me-2 p-2';
                tagSpan.innerHTML = `${option.text} <span class="tag-remove" data-tag-id="${option.value}" style="cursor: pointer; margin-left: 5px;">&times;</span>`;
                selectedTagsContainer.appendChild(tagSpan);
            });
        };
        
        // Function to add a tag (updates both hidden select and UI)
        const addTag = (id, name) => {
            // Check for duplicates (US-12 Negative Path: User enters a duplicate tag)
            const exists = Array.from(hiddenSelect.options).some(opt => opt.value == id && opt.selected);
            if (exists) {
                alert(`Warning: Tag "${name}" already exists.`); // Basic JS warning
                return;
            }
            
            // Try to find the existing option element and select it
            let option = hiddenSelect.querySelector(`option[value="${id}"]`);
            
            if (option) {
                option.selected = true;
            } else {
                // If it doesn't exist (e.g., the tag was just created in the API, or not in initial form options), 
                // we should add it dynamically.
                // NOTE: This approach assumes the tag ID/name is valid for the server. 
                // For true "create-on-the-fly," you'd need a separate API call to create the tag first.
                // For this basic setup, we assume we are only selecting existing tags.
                // If the form doesn't contain the tag, it means the tag exists only in the DB and needs to be added 
                // to the hidden select's options list.
                
                // For this example, we assume all available tags are loaded in the hiddenSelect's options initially, 
                // or the user *must* select from the list.
                // To allow adding a new tag (if the user submits a name not in the list), 
                // you would need a more complex widget or an async tag creation API.
            }

            updateSelectedTagsUI();
        };

        // Function to remove a tag
        const removeTag = (id) => {
            const option = hiddenSelect.querySelector(`option[value="${id}"]`);
            if (option) {
                option.selected = false;
            }
            updateSelectedTagsUI();
        };

        // Handle text input (debounce for performance)
        let timeout = null;
        inputField.addEventListener('input', (e) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => fetchSuggestions(e.target.value), 300);
        });

        // Event delegation for removing tags
        selectedTagsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('tag-remove')) {
                const tagId = e.target.getAttribute('data-tag-id');
                removeTag(tagId);
            }
        });
        
        // Initialize the UI on page load
        updateSelectedTagsUI();
    });
</script>
{% endblock content %}